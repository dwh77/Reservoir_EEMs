---
title: "CCR_hydrology_2024"
author: "Dexter Howard"
date: "2024-06-20"
output: html_document
---


## Get flowmate Q

```{r}
raw_q <- gsheet::gsheet2tbl("https://docs.google.com/spreadsheets/d/1niKKxyHLZfqnJEZ93nu49yCn0Wv_duW33bYS81PHY6o/edit#gid=0")

#manual Q function
# devtools::source_url("https://raw.githubusercontent.com/CareyLabVT/Reservoirs/master/Scripts/L1_generation_scripts/ManualDischarge_qaqc.R")

raw_q |> 
  filter(Reservoir == "CCR", 
         Site == 101) |> 
    filter(Method == "Flowmate") %>%   #filter to just flowmate measurements 
  mutate(Depth_m = Depth_cm/100,    
         Velocity_m.s = ifelse(Velocity_unit %in% c("ft_s", "ft/s"), Velocity*0.3048, Velocity), 
         Discharge = Depth_m * Velocity_m.s * WidthInterval_m    ) %>% 
  group_by(Reservoir, Site, Date) %>% #group by site and date
  summarise(Discharge_m3s = sum(Discharge, na.rm = T),  #sum across intervals to get final discharge
         Method = "F") 
  
  
```



## HOBO water level calculations

```{r}
########### get data ###############

### CCR met 
#ccr_met_edi <- read_csv("https://pasta.lternet.edu/package/data/eml/edi/1105/2/5c9281623ab7676ca1be85ee1761bf28")
ccr_met_git <- read_csv("https://raw.githubusercontent.com/FLARE-forecast/CCRE-data/ccre-dam-data-qaqc/ccre_met_L1.csv") 

##format for bind 
ccr_met_bind <- ccr_met_git |> 
  select(DateTime, BP_Average_kPa, Flag_BP_Average_kPa) |> 
  mutate(Date = as.Date(DateTime),
         Hour = hour(DateTime),
         Min = minute(DateTime)) |> 
  filter(Min %in% c(0,10,20,30,40,50)) |>  #get just minutes to line up w/ HOBO
  rename(DateTime_EST = DateTime) |> 
  select(DateTime_EST, BP_Average_kPa, Flag_BP_Average_kPa) 
#check BP flag
  

### HOBO water level
# hobo_22may24 <- read_csv("https://raw.githubusercontent.com/CareyLabVT/ManualDownloadsSCCData/master/CCR_manual_downloads/CCR_Hobos/HPB_waterlevel/hobo_hpb_22may24.csv", skip = 1)

hobo_11jul24 <- read_csv("https://raw.githubusercontent.com/CareyLabVT/ManualDownloadsSCCData/master/CCR_manual_downloads/CCR_Hobos/HPB_waterlevel/hobo_hpb_11jul24.csv", skip = 1)

#set time where sensor may have been out of the water
maintenance <- c(seq(ymd_hms("2024-05-22 15:00:00"), ymd_hms("2024-05-22 16:00:00"), by = "10 min"),
                 seq(ymd_hms("2024-06-19 11:00:00"), ymd_hms("2024-06-19 12:20:00"), by = "10 min"),
                 seq(ymd_hms("2024-07-11 11:00:00"), ymd_hms("2024-07-11 12:00:00"), by = "10 min")
                 )

hobo_bind <- hobo_11jul24 |> 
  rename(DateTime_EDT = 2, 
         HOBO_Abs_Pres_kPa = 3,
         Temp_C = 4) |> 
  select(DateTime_EDT, HOBO_Abs_Pres_kPa, Temp_C) |> 
  mutate(DateTime_EDT = mdy_hms(DateTime_EDT)) |> 
  filter(!DateTime_EDT %in% maintenance) |> 
  mutate(Date = as.Date(DateTime_EDT),
         Hour = hour(DateTime_EDT),
         Min = minute(DateTime_EDT)) |> 
  mutate(Time_EST = paste(Hour+1, Min, 00, sep = ":"),
         DateTime_EST = ymd_hms(paste(Date, Time_EST, sep = " "))  ) |> 
  select(DateTime_EST, HOBO_Abs_Pres_kPa, Temp_C) 


############## bind data and calculate water level #######################

waterlevel_correct <- left_join(hobo_bind, ccr_met_bind, by = "DateTime_EST") |> 
  select(-Flag_BP_Average_kPa) |> 
  mutate(corrected_Pres_kPa = HOBO_Abs_Pres_kPa - BP_Average_kPa) |> 
  mutate(waterlevel_cm = corrected_Pres_kPa * 10.1972)


############### plot data ######################

waterlevel_correct |> 
  ggplot()+
  geom_line(aes(x=DateTime_EST, y = BP_Average_kPa, color = "MET"))+  
  geom_line(aes(x=DateTime_EST, y = HOBO_Abs_Pres_kPa, color = "HOBO_raw"))+
  geom_line(aes(x=DateTime_EST, y = corrected_Pres_kPa + 95, color = "HOBO_correct + 95"))

waterlevel_correct |> 
  ggplot(aes(x = DateTime_EST, y = waterlevel_cm))+
  geom_line()


##precip plot 
daily_rain <- ccr_met_git |> 
  filter(DateTime > ymd("2024-04-01")) |> 
  mutate(Date = as.Date(DateTime)) |> 
  group_by(Date) |> 
  summarise(Daily_rain = sum(Rain_Total_mm, na.rm = T))

 daily_rain|> 
  ggplot(aes(x = Date, y = Daily_rain))+
  geom_point()+
  geom_line()
  
#get daily water level and precip
waterlevel_daily <- waterlevel_correct |> 
  mutate(Date = as.Date(DateTime_EST)) |> 
  group_by(Date) |> 
  summarise(Daily_waterlevel = mean(waterlevel_cm, na.rm = T))

waterlevel_precip <-  left_join(daily_rain, waterlevel_daily, by = "Date")


```

Compare to USGS data 

```{r}
library(dataRetrieval)

#get data from USGS
sitenos <- c("02055100" , "02018500")

#get site info
siteinfo <- readNWISsite(sitenos)
data_available <- whatNWISdata(siteNumber = sitenos, service = "dv")

#get daily Q
startDate <- "2024-04-01" # "1987-01-01"
endDate <- Sys.Date()
parameter <- "00060"

Qdat <- readNWISdv(sitenos, parameter, startDate, endDate) %>% 
  renameNWISColumns()

Qdata <- left_join(Qdat, siteinfo, by = c("site_no"))



#################### subset data to compare to HPB #####################################3

Qdata |> 
  filter(Date >= ymd("2024-04-15")) |> 
  ggplot(aes(x = Date, y = Flow, color = site_no))+
  geom_line()

Qdata_forjoin <- Qdata |> 
  select(Date, site_no, Flow) |> 
  pivot_wider(names_from = site_no, values_from = Flow, names_prefix = "Flow_")


left_join(Qdata_forjoin, waterlevel_precip, by= "Date") |> 
  rename(CCR_MetStation_daily_rain_mm = Daily_rain,
         CCR_HPB_daily_waterlevel_cm = Daily_waterlevel,
         USGS_CatwabaCreek_dailyflow_cfs = Flow_02018500,
         USGS_TinkerCreek_dailyflow_cfs = Flow_02055100) |> 
  pivot_longer(-1) |> 
  filter(Date > ymd("2024-04-15")) |> 
  ggplot(aes(x = Date, y = value))+
  geom_point()+
  geom_vline(xintercept = ymd("2024-05-22"))+
  geom_vline(xintercept = ymd("2024-06-19"))+
  geom_vline(xintercept = ymd("2024-07-11"))+
  facet_wrap(~name, ncol = 1, scales = "free_y")+
  labs(x= element_blank())+
  theme_bw()+ theme(text = element_text(size = 18))



```

