---
title: "CCR Spatial chemistry"
author: "Dexter Howard"
date: "2024-06-20"
output: html_document
---

## Read in packages 

```{r, include = F}
library(tidyverse)
# library(scales) #for date format on plots
# library(patchwork) #arrange figures w/ slashes and lines
# library(plotly)


```


## Read in EEMs

Get EEM data 

```{r}
## bring in distances and site class table from google sheets; have to redownload locally each time 
distances <- read.csv("C:/Users/dwh18/Downloads/2024 spatial sampling - Distances.csv") |> 
  mutate(Date = mdy(Date)) |> 
  select(-c(13,14)) |> 
  pivot_longer(-c(1,11,12), names_to = "Site_code", values_to = "Distance_ft")

site_class <- read.csv("C:/Users/dwh18/Downloads/2024 spatial sampling - Sites_Class.csv") |> 
  select(-X, -Key) |> 
  mutate(Date = mdy(Date)) |> 
  pivot_longer(-c(1), names_to = "Site_code", values_to = "Site_Class") |> 
  mutate(Site_Class = ifelse(Site_Class %in% c("S", "S "), "Stream", Site_Class),
         Site_Class = ifelse(Site_Class %in% c("P", "P "), "Pool", Site_Class),
         Site_Class = ifelse(Site_Class == "C", "Cove", Site_Class),
         Site_Class = ifelse(Site_Class == "L", "Pelagic", Site_Class))



## EEM data
eems24 <- read.csv("../EEMs_Results_2024.csv")

eems <- eems24 |> 
  # mutate(Distance_ft = ifelse(Site == 101, 0, NA),
  #        Distance_ft = ifelse(Site == 100, 407, Distance_ft),
  #        Distance_ft = ifelse(Site == 98, 619, Distance_ft),
  #        Distance_ft = ifelse(Site == 96, 790, Distance_ft),
  #        Distance_ft = ifelse(Site == 94, 1015, Distance_ft),
  #        Distance_ft = ifelse(Site == 92, 1132, Distance_ft),
  #        Distance_ft = ifelse(Site == 90, 1843, Distance_ft),
  #        Distance_ft = ifelse(Site == 88, 3326, Distance_ft),
  #        Distance_ft = ifelse(Site == 50, 5011, Distance_ft),
  #        Distance = Distance_ft*0.3048) |> 
    mutate(Date = mdy(Date),
           Date = ifelse(Date == ymd("2024-08-15"), ymd("2024-08-14"), Date),
           Date = as.Date(Date),
           Site_code = ifelse(Site == 101, "S1", NA),
         Site_code = ifelse(Site == 100, "S2", Site_code),
         Site_code = ifelse(Site == 98, "P1", Site_code),
         Site_code = ifelse(Site == 96, "P2", Site_code),
         Site_code = ifelse(Site == 94, "C1", Site_code),
         Site_code = ifelse(Site == 92, "C2", Site_code),
         Site_code = ifelse(Site == 90, "C3", Site_code),
         Site_code = ifelse(Site == 88, "C4", Site_code),
         Site_code = ifelse(Site == 50, "50", Site_code)
         ) |> 
  select(Reservoir, Site, Site_code, Depth_m, Date, FI., HIX., BIX., T., A., A.T., a254, a350, A254, A350, NOTES)


eems_plotting <- left_join(eems, distances, by = c("Site_code", "Date")) |> 
  left_join(site_class, by = c("Site_code", "Date")) |> 
  mutate(Distance = Distance_ft*0.3048,
         Dry_start = Dry_start*0.3048,
         Dry_end = Dry_end*0.3048) |> 
  filter(!Date %in% c(ymd("2024-07-31"), ymd("2024-08-01"))) |> 
  select(Reservoir, Site, Site_code, Site_Class, Depth_m, Date, Distance, Dry_start, Dry_end, FI., HIX., BIX., T., A., A.T., a254, a350, NOTES)


eems_plotting

```


## Rep checks 

```{r}
#summarize data 
eems_summary <- eems_plotting |> 
  filter(!NOTES %in% c("PART")) |> 
  filter(Site_code != "C1") |> 
  rename(HIX = HIX.,
         BIX = BIX.) |>  #### can just change the rename here for what value you want to look at
  select(Site, Site_Class, Depth_m, Date, Distance, Dry_start, Dry_end, HIX, BIX) |> 
  group_by(Site, Site_Class, Depth_m, Date, Dry_start, Dry_end, Distance) |> 
  summarise(HIX_mean = mean(HIX, na.rm = T),
            HIX_min = min(HIX, na.rm = T),
            HIX_max = max(HIX, na.rm = T),
            BIX_mean = mean(BIX, na.rm = T),
            BIX_min = min(BIX, na.rm = T),
            BIX_max = max(BIX, na.rm = T)
                        ) |> 
  mutate(Rep = ifelse(HIX_mean != HIX_min, "Y", "N"))


#plot w/ error bars
eems_summary |> 
  ggplot(aes(x = Distance, y = HIX_mean, color = Depth_m)) +
  geom_point(size = 1) +  # Plot the mean values as points
  geom_errorbar(
    aes(ymin = HIX_min, ymax = HIX_max),
    width = 2  # Width of the error bars
  ) +
  facet_wrap(~Date, nrow = 4)+
  theme_bw()

#by site and date
eems_summary |> 
  filter(Rep == "Y") |> 
  ggplot(aes(y = Depth_m, x= HIX_mean))+
  geom_point(size = 1) +  
  geom_errorbar(
    aes(xmin = HIX_min, xmax = HIX_max),
    width = 2 )+
  # xlim(3,6)+
  facet_grid(Site~Date)
  


```



## EEMs plots by distance, value on Y

Depth by gradient  

```{r}
#HIX averaging reps 
eems_summary |> 
  ggplot(aes(x = Distance, y = HIX_mean, color = Depth_m, fill = Depth_m,
             shape = factor(Site_Class, levels = c("Stream", "Pool", "Cove", "Pelagic"))))+
  geom_point() + 
  geom_errorbar(aes(ymin = HIX_min, ymax = HIX_max), width = 2) +
  facet_wrap(~Date, nrow = 4)+
  facet_wrap(~Date, scales = "fixed", ncol = 6)+ 
  geom_rect(aes(xmin = Dry_start, xmax = Dry_end, ymin = -Inf, ymax = Inf), 
            alpha = 0.01, fill = "gray", color = NA )+ #color gets rid of border
  ylim(1.45,14.4)+
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18))+
    labs(x= "Distance from Stream (m)",
       shape = "Site Type")+
  scale_shape_manual(values = c(24, 22, 21, 25))+ #18, 15, 16, 17
  scale_color_gradient(high = "#CFCFCF", low = "black", breaks = c(3,6,9,12))+
  scale_fill_gradient(high = "#CFCFCF", low = "black",  breaks = c(3,6,9,12)) # high = "black", low = "#CFCFCF"  ;  high = "red", low = "blue"


#BIX averaging reps 
eems_summary |> 
  ggplot(aes(x = Distance, y = BIX_mean, color = Depth_m, fill = Depth_m,
             shape = factor(Site_Class, levels = c("Stream", "Pool", "Cove", "Pelagic"))))+
  geom_point() + 
  geom_errorbar(aes(ymin = BIX_min, ymax = BIX_max), width = 2) +
  facet_wrap(~Date, nrow = 4)+
  facet_wrap(~Date, scales = "fixed", ncol = 6)+ 
  geom_rect(aes(xmin = Dry_start, xmax = Dry_end, ymin = -Inf, ymax = Inf), 
            alpha = 0.01, fill = "gray", color = NA )+ #color gets rid of border
  ylim(0.51, 0.89)+
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18))+
    labs(x= "Distance from Stream (m)",
       shape = "Site Type")+
  scale_shape_manual(values = c(24, 22, 21, 25))+ #18, 15, 16, 17
  scale_color_gradient(high = "#CFCFCF", low = "black", breaks = c(3,6,9,12))+
  scale_fill_gradient(high = "#CFCFCF", low = "black",  breaks = c(3,6,9,12)) # high = "black", low = "#CFCFCF"  ;  high = "red", low = "blue"


```

Depth by group

```{r}

#averaging reps  AND TRYING DEPTH SHAPE GROUPS
levels_depthgroup <- c("0.1m", "0.2 - 1m",  "1 - 2m", "3 - 7m", "9m", " >= 10m")

#HIX
eems_summary |> 
  mutate(depth_group = ifelse(Depth_m == 0.1, "0.1m", NA),
         depth_group = ifelse(Depth_m <= 1 & Depth_m > 0.1, "0.2 - 1m", depth_group),
         depth_group = ifelse(Depth_m <= 2 & Depth_m > 1, "1 - 2m", depth_group),
         depth_group = ifelse(Depth_m <= 7 & Depth_m >= 3, "3 - 7m", depth_group),
         depth_group = ifelse(Depth_m == 9 , "9m", depth_group),
         depth_group = ifelse(Depth_m >= 10 , " >= 10m", depth_group)
         ) |> 
  ggplot(aes(x = Distance, y = HIX_mean, color = factor(depth_group, levels = levels_depthgroup))) +
  geom_point() + 
  geom_errorbar(aes(ymin = HIX_min, ymax = HIX_max), width = 2) +
  facet_wrap(~Date, nrow = 4)+
  facet_wrap(~Date, scales = "fixed", ncol = 6)+ 
  geom_rect(aes(xmin = Dry_start, xmax = Dry_end, ymin = 2, ymax = 2.5), # for BIX use 0.5 and 0.51
             alpha = 0.1, fill = "blue" )+
  labs(color = "Depth", y = "HIX")+
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18))+ guides(colour = guide_legend(nrow = 1))

#BIX
eems_summary |> 
  mutate(depth_group = ifelse(Depth_m == 0.1, "0.1m", NA),
         depth_group = ifelse(Depth_m <= 1 & Depth_m > 0.1, "0.2 - 1m", depth_group),
         depth_group = ifelse(Depth_m <= 2 & Depth_m > 1, "1 - 2m", depth_group),
         depth_group = ifelse(Depth_m <= 7 & Depth_m >= 3, "3 - 7m", depth_group),
         depth_group = ifelse(Depth_m == 9 , "9m", depth_group),
         depth_group = ifelse(Depth_m >= 10 , " >= 10m", depth_group)
         ) |> 
  ggplot(aes(x = Distance, y = BIX_mean, color = factor(depth_group, levels = levels_depthgroup))) +
  geom_point() + 
  geom_errorbar(aes(ymin = BIX_min, ymax = BIX_max), width = 2) +
  facet_wrap(~Date, nrow = 4)+
  facet_wrap(~Date, scales = "fixed", ncol = 2)+ 
  geom_rect(aes(xmin = Dry_start, xmax = Dry_end, ymin = 0.5, ymax = 0.51), # for BIX use 0.5 and 0.51
             alpha = 0.1, fill = "blue" )+
  labs(color = "Depth", y = "BIX")+
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18))+ guides(colour = guide_legend(nrow = 1))


```



## by Codes 

```{r}
##previous style plot
levels_sites <- c(101, 100, 98, 96, 94, 92, 90, 88, 50)
levels_sites_code <- c("S1", "S2", "P1", "P2", "C1", "C2", "C3", "C4", "50")


# set up colors for factored depths 
depths <- c(0.1, 0.5, 1, 1.5, 2, 6)
colors <- scales::seq_gradient_pal(low = "blue", high = "#ff0000", space = "Lab")(1:6/6)
color_values <- setNames(colors, depths)

## HIX and BIX by date w/ depth as specific color 
eems_plotting |> 
  select(Reservoir, Site, Site_code, Depth_m, Date, Distance, FI., HIX., BIX.) |> 
  pivot_longer(-c(1:6)) |> 
  # ggplot(aes(x = factor(Site, level = levels_sites), y = value, color = factor(Depth_m)))+
  ggplot(aes(x = factor(Site_code, level = levels_sites_code), y = value, color = factor(Depth_m)))+
  geom_jitter(size = 2.5, width = 0.1)+
  facet_wrap(~name, nrow = 3, scales = "free_y")+
  # labs(title = "HPB", y = "Temp (C)", x = "Site")+
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18))+
  scale_color_manual(values = c("0.1" = "#66ADE5", "0.5" = "#BF1B0B", "1.5" = "#FFC465", "2" = "#009E73", "6" = "#252A52"))
  # scale_color_manual(values = color_values)
  # scale_color_gradient("Depth_m",  high = "red", low = "blue") 
  
### HIX and BIX by date with Depth as specific color as gradient 
eems_plotting |>
  select(1:6, HIX., BIX.) |> 
  pivot_longer(-c(1:6)) |>
  # ggplot(aes(x = Distance, y = value, color = Depth_m))+
  ggplot(aes(x = factor(Site_code, levels = levels_sites_code), y = value, color = Depth_m))+
  geom_point()+
  #facet_wrap(~Date, nrow = 3, scales = "free_y")+
  facet_grid(name~Date, scales = "free_y")+
  labs(x = element_blank())+
  theme_bw()+ theme(legend.position = "right", text = element_text(size = 14))+
  scale_color_gradient("Depth_m",  high = "red", low = "blue")

## hIX by date with depth on Y
eems_plotting |>
  select(1:6, HIX.) |> 
  pivot_longer(-c(1:6)) |>
  ggplot(aes(x = factor(Site_code, levels = levels_sites_code), y = Depth_m, color = value))+
  geom_point()+
  scale_y_reverse()+
  facet_grid(name~Date, scales = "free_y")+ 
  theme_bw()+ theme(legend.position = "right", text = element_text(size = 14))+
  # viridis::scale_color_viridis()
  scale_color_gradient(high = "black", low = "#CFCFCF") # has also done red to blue w/ some luck
  # scale_color_gradientn(colors = magma(256))

## BIX by date with depth on Y
eems_plotting |>
  select(1:6, BIX.) |> 
  pivot_longer(-c(1:6)) |>
  ggplot(aes(x = factor(Site_code, levels = levels_sites_code), y = Depth_m, color = value))+
  geom_point()+
  scale_y_reverse()+
  facet_grid(name~Date, scales = "free_y")+ 
  theme_bw()+ theme(legend.position = "right", text = element_text(size = 14))+
  scale_color_gradient(high = "black", low = "#CFCFCF") # has also done red to blue w/ some luck


##### NEW STYLE TRials 
eems_plotting |>
  select(1:6, BIX.) |> 
  pivot_longer(-c(1:6)) |>
  ggplot(aes(x = value, y = Depth_m, color = as.factor(Distance)))+
  geom_point()+
  geom_line(orientation = "y")+
  scale_y_reverse()+
  facet_wrap(~Date, scales = "free_y")+ 
  theme_bw()+ theme(legend.position = "right", text = element_text(size = 14))
  # scale_color_gradient(high = "black", low = "#CFCFCF") # has also done red to blue w/ some luck
  

```



## MSN eems

```{r}
eems_MSN <- eems24 |> 
  mutate(Date = mdy(Date)) |> 
  filter(Date %in% c(ymd("2024-07-31"), ymd("2024-08-01")))

head(eems_MSN)

eems_MSN |> 
  ggplot(aes(x = factor(TIME, levels = c("noon", "midnight", "6am")), y = HIX., color = Depth_m))+
  geom_point()


eems_MSN |> 
  ggplot(aes(x = factor(TIME, levels = c("noon", "midnight", "6am")), y = BIX., color = Depth_m))+
  geom_point()

```




