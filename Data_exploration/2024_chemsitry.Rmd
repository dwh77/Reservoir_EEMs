---
title: "CCR Spatial chemistry"
author: "Dexter Howard"
date: "2024-06-20"
output: html_document
---

## Read in packages 

```{r, include = F}
library(tidyverse)
# library(scales) #for date format on plots
# library(patchwork) #arrange figures w/ slashes and lines
# library(plotly)


```

## Read in A lab chem

Clean up data

```{r}
Site_code_number <- data.frame(Site_code = c("CS1", "CS2", "CP1", "CP2", "CC1", "CC2", "CC3", "CC4", "C50"),
                               Site_number = c(101, 100, 98, 96, 94, 92, 90, 88, 50))
# 
#### RUN 1 ####

# doc1 <- read.csv("C:/Users/dwh18/OneDrive/Desktop/Alab_QAQC/2024/CCR_solubles1/ccr_doc1.csv")
# sol1 <- read.csv("C:/Users/dwh18/OneDrive/Desktop/Alab_QAQC/2024/CCR_solubles1/ccr_solubles1.csv")
# 
# solubles <- full_join(doc1, sol1, by = c("Sample_ID" = "Sample_Names"))
# 
# names <- solubles |> 
#   select(Sample_ID) |> 
#   # mutate(Name = substr(SampleName, 10, nchar(SampleName)),   #get rid of yyyymmdd_ at start       
#   #        Name = str_sub(Name, 1, str_length(Name)-4)) |> #remove .csv from end
#   # mutate(Name = sapply(Name, add_underscore)) |>  # add underscore between depth and rep
#     mutate(Name = Sample_ID) |> 
#   separate(Name, into = paste0("part", 1:4), sep = "_", fill = "right") |> #break Name into four columns
#   rename(Site_code = part1,
#          Date = part2,
#          Depth = part3,
#          Rep = part4) |>  #give columns meaningful names
#   mutate(Rep = ifelse(Rep %in% c("r1", "R1"), 1, 2)) |> #update rep values 
#   mutate(Depth_m = ifelse(Depth %in% c("0.1m"), "0.1", NA),
#          Depth_m = ifelse(Depth %in% c("1.5m"), "1.5", Depth_m),
#          Depth_m = ifelse(Depth %in% c("6m"), "6", Depth_m),
#          Depth_m = ifelse(Depth %in% c("9m"), "9", Depth_m),
#          Depth_m = ifelse(Depth %in% c("BOT"), "BOT", Depth_m)) |>  #update depths that are easy, will assign BOT manually later
#   mutate(Date = dmy(Date),
#          Reservoir = "CCR") |> 
#   left_join(Site_code_number, by = "Site_code") |> 
#   select(Reservoir, Site_code, Site_number, Depth_m, Date, Rep, Sample_ID)
# 
# # unique(names$Depth)
# 
# solublesA <- left_join(names, solubles, by = "Sample_ID")
# 
# write.csv(solublesA, "./solubles1_v1.csv", row.names = F)


#### RUN 2 ####
# doc2 <- read.csv("C:/Users/dwh18/OneDrive/Desktop/Alab_QAQC/2024/CCR_LTREB_solubles2/TOC/ccr_doc2.csv")|>
#   filter(!Sample_ID %in% c("", "sampleID", "SampleID"))
# 
# lachat2 <- read.csv("C:/Users/dwh18/OneDrive/Desktop/Alab_QAQC/2024/CCR_LTREB_solubles2/Lachat_14nov24_solubles/ccr_solubles2.csv")|>
#   filter(!sample_name %in% c(""))
# 
# solubles2 <- full_join(doc2, lachat2, by = c("Sample_ID" = "sample_name"))
# 
# names2 <- solubles2 |>
#   select(Sample_ID) |>
#   # mutate(Name = substr(SampleName, 10, nchar(SampleName)),   #get rid of yyyymmdd_ at start
#   #        Name = str_sub(Name, 1, str_length(Name)-4)) |> #remove .csv from end
#   # mutate(Name = sapply(Name, add_underscore)) |>  # add underscore between depth and rep
#     mutate(Name = Sample_ID) |>
#   separate(Name, into = paste0("part", 1:4), sep = "_", fill = "right") |> #break Name into four columns
#   rename(Site_code = part1,
#          Date = part2,
#          Depth = part3,
#          Rep = part4) |>  #give columns meaningful names
#   mutate(Rep = ifelse(Rep %in% c("r1", "R1"), 1, 2)) |> #update rep values
#   mutate(Depth_m = ifelse(Depth %in% c("0.1m"), "0.1", NA),
#          Depth_m = ifelse(Depth %in% c("1.5m"), "1.5", Depth_m),
#          Depth_m = ifelse(Depth %in% c("6m"), "6", Depth_m),
#          Depth_m = ifelse(Depth %in% c("9m"), "9", Depth_m),
#          Depth_m = ifelse(Depth %in% c("20m"), "20", Depth_m),
#          Depth_m = ifelse(Depth %in% c("BOT"), "BOT", Depth_m)) |>  #update depths that are easy, will assign BOT manually later
#   mutate(Date = dmy(Date),
#          Reservoir = "CCR") |>
#   left_join(Site_code_number, by = "Site_code") |>
#   select(Reservoir, Site_code, Site_number, Depth_m, Date, Rep, Sample_ID)
# 
# solublesA2 <- left_join(names2, solubles2, by = "Sample_ID")
# 
# write.csv(solublesA2, "./solubles2_v1.csv", row.names = F)



```


Bind data from instrument and make a csv that I can edit the BOT depths 

```{r}

ccr_solubles1 <- read.csv("./solubles1_v2.csv")
ccr_solubles2 <- read.csv("./solubles2_v2.csv") |> 
  rename(NH4 = 14, PO4 = 15, NO3 = 16)

ccr_solubles <- rbind(ccr_solubles1, ccr_solubles2)|> 
  mutate(NO3 = ifelse(NO3 < 0, 0, NO3),
         NH4 = ifelse(NH4 < 0, 0, NH4),
         PO4 = ifelse(PO4 < 0, 0, PO4)) |> 
  mutate(Date = mdy(Date)) |> 
  mutate(Site_code = ifelse(Date == ymd("2024-05-22") & Site_code == "CC4", "CC3", Site_code),
         Site_code = ifelse(Date == ymd("2024-05-22") & Site_code == "CC5", "CC4", Site_code)) |> 
  mutate(Site_code = substr(Site_code, 2, nchar(Site_code))) |> 
  mutate(Site_code = ifelse(Site_code =="50", "C50", Site_code)) |> 
  mutate(Date = ifelse(Date == ymd("2024-08-15"), ymd("2024-08-14"), Date),
         Date = as.Date(Date)) 

  

solubles_plotting <- left_join(ccr_solubles, distances, by = c("Site_code", "Date")) |> 
  left_join(site_class, by = c("Site_code", "Date")) |> 
  mutate(Distance = Distance_ft*0.3048,
         Dry_start = Dry_start*0.3048,
         Dry_end = Dry_end*0.3048) |> 
  filter(!Date %in% c(ymd("2024-07-31"), ymd("2024-08-01"))) |> 
  rename(DOC = 10,
         Site = Site_number) |> 
  select(Reservoir, Site, Site_code, Site_Class, Depth_m, Date, Rep, Distance, Dry_start, Dry_end, DOC, NO3, NH4, PO4 )


```

plot it! 

```{r}
#summarize
## something going wrong in here
solubles_summary <- solubles_plotting |>
  select(Site, Site_Class, Depth_m, Date, Distance, Dry_start, Dry_end, DOC, NO3, NH4, PO4) |>
  group_by(Site, Site_Class, Depth_m, Date, Dry_start, Dry_end, Distance) |>
  summarise(DOC_mean = mean(DOC, na.rm = T),
            DOC_min = min(DOC, na.rm = T),
            DOC_max = max(DOC, na.rm = T),
            PO4_mean = mean(PO4, na.rm = T),
            PO4_min = min(PO4, na.rm = T),
            PO4_max = max(PO4, na.rm = T),
            NH4_mean = mean(NH4, na.rm = T),
            NH4_min = min(NH4, na.rm = T),
            NH4_max = max(NH4, na.rm = T),
            NO3_mean = mean(NO3, na.rm = T),
            NO3_min = min(NO3, na.rm = T),
            NO3_max = max(NO3, na.rm = T)
                        ) |>
  mutate(Rep = ifelse(DOC_mean != DOC_min, "Y", "N"))


#check missing samples 
z <- arrange(solubles_plotting, Date, desc(Site), Depth_m)


#### Rep check
solubles_summary |> 
  filter(Rep == "Y") |> ggplot(aes(y = Depth_m, x= DOC_mean))+
  geom_point(size = 1) +    geom_errorbar(aes(xmin = DOC_min, xmax = DOC_max),    width = 2 )+
  facet_grid(Site~Date) + labs(title = "DOC reps")

solubles_summary |> 
  filter(Rep == "Y") |> ggplot(aes(y = Depth_m, x= PO4_mean))+
  geom_point(size = 1) +    geom_errorbar(aes(xmin = PO4_min, xmax = PO4_max),    width = 2 )+
  facet_grid(Site~Date) + labs(title = "PO4 reps")


#### PLOT

##DOC
solubles_summary |> 
  #filter(!Site == 50) |> 
  ggplot(aes(x = Distance, y = DOC_mean, fill = Depth_m,
             shape = factor(Site_Class, levels = c("Stream", "Pool", "Cove", "Pelagic"))))+
  geom_point(size = 3) + 
  geom_errorbar(aes(ymin = DOC_min, ymax = DOC_max), width = 2) +
  facet_wrap(~Date, scales = "fixed", ncol = 4)+ 
  geom_rect(aes(xmin = Dry_start, xmax = Dry_end, ymin = -Inf, ymax = Inf), alpha = 0.01, fill = "gray", color = NA )+ 
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18),
                    panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
    labs(y = "DOC (mg/L)", x= "Distance from Stream (m)",  shape = "Site Type")+
  scale_x_continuous(breaks = c(0, 500, 1000, 1500))+ #c(250, 750)
  scale_shape_manual(values = c(24, 22, 21, 25))+ #18, 15, 16, 17
  scale_fill_gradient2(low = "red",  high ="blue",
                       midpoint = 9,  guide = "colourbar", breaks = c(3,6,9, 15, 20))

    #across dates
solubles_summary |> 
  ggplot(aes(x = Distance, y = DOC_mean, fill = Depth_m ))+
  geom_smooth()+
  geom_point(shape = 21, size = 3) + 
  geom_errorbar(aes(ymin = DOC_min, ymax = DOC_max), width = 2) +
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18),
                    panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  labs(x= "Distance from Stream (m)",  fill = "Depth (m)", y = "DOC (mg/L)")+
  scale_x_continuous(breaks = c(0, 500, 1000, 1500))+  
  scale_fill_gradient2(low = "red",  high ="blue",
                       midpoint = 6,  guide = "colourbar", breaks = c(3,6,9, 15, 20))

##PO4
solubles_summary |> 
  #filter(!Site == 50) |> 
  ggplot(aes(x = Distance, y = PO4_mean, fill = Depth_m,
             shape = factor(Site_Class, levels = c("Stream", "Pool", "Cove", "Pelagic"))))+
  geom_point() + 
  geom_errorbar(aes(ymin = PO4_min, ymax = PO4_max), width = 2) +
  facet_wrap(~Date, scales = "fixed", ncol = 4)+ 
  geom_rect(aes(xmin = Dry_start, xmax = Dry_end, ymin = -Inf, ymax = Inf), alpha = 0.01, fill = "gray", color = NA )+ 
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18),
                    panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
    labs(y = "PO4 (ug/L)", x= "Distance from Stream (m)",  shape = "Site Type")+
  scale_x_continuous(breaks = c(0, 500, 1000, 1500))+ #c(250, 750)
  scale_shape_manual(values = c(24, 22, 21, 25))+ #18, 15, 16, 17
  scale_fill_gradient2(low = "red",  high ="blue",
                       midpoint = 9,  guide = "colourbar", breaks = c(3,6,9, 15, 20))


##NO3
solubles_summary |> 
  #filter(!Site == 50) |> 
  ggplot(aes(x = Distance, y = NO3_mean, fill = Depth_m,
             shape = factor(Site_Class, levels = c("Stream", "Pool", "Cove", "Pelagic"))))+
  geom_point() + 
  geom_errorbar(aes(ymin = NO3_min, ymax = NO3_max), width = 2) +
  facet_wrap(~Date, scales = "fixed", ncol = 4)+ 
  geom_rect(aes(xmin = Dry_start, xmax = Dry_end, ymin = -Inf, ymax = Inf), alpha = 0.01, fill = "gray", color = NA )+ 
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18),
                    panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
    labs(y = "NO3 (ug/L)", x= "Distance from Stream (m)",  shape = "Site Type")+
  scale_x_continuous(breaks = c(0, 500, 1000, 1500))+ #c(250, 750)
  scale_shape_manual(values = c(24, 22, 21, 25))+ #18, 15, 16, 17
  scale_fill_gradient2(low = "red",  high ="blue",
                       midpoint = 9,  guide = "colourbar", breaks = c(3,6,9, 15, 20))

##NH4
solubles_summary |> 
  #filter(!Site == 50) |> 
  ggplot(aes(x = Distance, y = NH4_mean, fill = Depth_m,
             shape = factor(Site_Class, levels = c("Stream", "Pool", "Cove", "Pelagic"))))+
  geom_point() + 
  geom_errorbar(aes(ymin = NH4_min, ymax = NH4_max), width = 2) +
  facet_wrap(~Date, scales = "fixed", ncol = 4)+ 
  geom_rect(aes(xmin = Dry_start, xmax = Dry_end, ymin = -Inf, ymax = Inf), alpha = 0.01, fill = "gray", color = NA )+ 
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18),
                    panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
    labs(y = "NH4 (ug/L)", x= "Distance from Stream (m)",  shape = "Site Type")+
  scale_x_continuous(breaks = c(0, 500, 1000, 1500))+ #c(250, 750)
  scale_shape_manual(values = c(24, 22, 21, 25))+ #18, 15, 16, 17
  scale_fill_gradient2(low = "red",  high ="blue",
                       midpoint = 9,  guide = "colourbar", breaks = c(3,6,9, 15, 20))



# ##trying virdis
# solubles_summary |> 
#   #filter(!Site == 50) |> 
#   ggplot(aes(x = Distance, y = DOC_mean, fill = Depth_m, #fill = Depth_m,
#              shape = factor(Site_Class, levels = c("Stream", "Pool", "Cove", "Pelagic"))))+
#   geom_point() + 
#   geom_errorbar(aes(ymin = DOC_min, ymax = DOC_max), width = 2) +
#   facet_wrap(~Date, scales = "fixed", ncol = 4)+ 
#   geom_rect(aes(xmin = Dry_start, xmax = Dry_end, ymin = -Inf, ymax = Inf), alpha = 0.01, fill = "gray", color = NA )+ 
#   theme_bw()+ theme(legend.position = "top", text = element_text(size = 18))+
#     labs(x= "Distance from Stream (m)",  shape = "Site Type")+
#   scale_shape_manual(values = c(24, 22, 21, 25))+ #18, 15, 16, 17
#   scale_fill_viridis_c(breaks = c(3,6,9,12, 15,18))
#   scale_color_gradient(high = "#CFCFCF", low = "black", breaks = c(3,6,9,12))+  scale_fill_gradient(high = "#CFCFCF", low = "black",  breaks = c(3,6,9,12)) 


```



## Read in EEMs

Get EEM data 

```{r}
## bring in distances and site class table from google sheets; have to redownload locally each time 
distances <- read.csv("C:/Users/dwh18/Downloads/2024 spatial sampling - Distances.csv") |> 
  mutate(Date = mdy(Date)) |> 
  dplyr::select(-c(13,14)) |> 
  pivot_longer(-c(1,11,12), names_to = "Site_code", values_to = "Distance_ft")

site_class <- read.csv("C:/Users/dwh18/Downloads/2024 spatial sampling - Sites_Class.csv") |> 
  dplyr::select(-X, -Key) |> 
  mutate(Date = mdy(Date)) |> 
  pivot_longer(-c(1), names_to = "Site_code", values_to = "Site_Class") |> 
  mutate(Site_Class = ifelse(Site_Class %in% c("S", "S "), "Stream", Site_Class),
         Site_Class = ifelse(Site_Class %in% c("P", "P "), "Pool", Site_Class),
         Site_Class = ifelse(Site_Class == "C", "Cove", Site_Class),
         Site_Class = ifelse(Site_Class == "L", "Pelagic", Site_Class))



## EEM data
eems24 <- read.csv("../EEMs_Results_2024.csv")

zz <- arrange(eems24, mdy(Date), desc(Site), Depth_m)


eems <- eems24 |> 
  # mutate(Distance_ft = ifelse(Site == 101, 0, NA),
  #        Distance_ft = ifelse(Site == 100, 407, Distance_ft),
  #        Distance_ft = ifelse(Site == 98, 619, Distance_ft),
  #        Distance_ft = ifelse(Site == 96, 790, Distance_ft),
  #        Distance_ft = ifelse(Site == 94, 1015, Distance_ft),
  #        Distance_ft = ifelse(Site == 92, 1132, Distance_ft),
  #        Distance_ft = ifelse(Site == 90, 1843, Distance_ft),
  #        Distance_ft = ifelse(Site == 88, 3326, Distance_ft),
  #        Distance_ft = ifelse(Site == 50, 5011, Distance_ft),
  #        Distance = Distance_ft*0.3048) |> 
    mutate(Date = mdy(Date),
           Date = ifelse(Date == ymd("2024-08-15"), ymd("2024-08-14"), Date),
           Date = as.Date(Date),
           Site_code = ifelse(Site == 101, "S1", NA),
         Site_code = ifelse(Site == 100, "S2", Site_code),
         Site_code = ifelse(Site == 98, "P1", Site_code),
         Site_code = ifelse(Site == 96, "P2", Site_code),
         Site_code = ifelse(Site == 94, "C1", Site_code),
         Site_code = ifelse(Site == 92, "C2", Site_code),
         Site_code = ifelse(Site == 90, "C3", Site_code),
         Site_code = ifelse(Site == 88, "C4", Site_code),
         Site_code = ifelse(Site == 50, "C50", Site_code)
         ) |> 
  dplyr::select(Reservoir, Site, Site_code, Depth_m, Date, FI., HIX., BIX., T., A., A.T., a254, a350, A254, A350, NOTES)


eems_plotting <- left_join(eems, distances, by = c("Site_code", "Date")) |> 
  left_join(site_class, by = c("Site_code", "Date")) |> 
  mutate(Distance = Distance_ft*0.3048,
         Dry_start = Dry_start*0.3048,
         Dry_end = Dry_end*0.3048) |> 
  filter(!Date %in% c(ymd("2024-07-31"), ymd("2024-08-01"))) |> 
  dplyr::select(Reservoir, Site, Site_code, Site_Class, Depth_m, Date, Distance, Dry_start, Dry_end, FI., HIX., BIX., T., A., A.T., a254, a350, NOTES)


eems_plotting

```


## Rep checks 

```{r}
#summarize data 
eems_summary <- eems_plotting |> 
  filter(!NOTES %in% c("PART")) |> 
  filter(Site_code != "C1") |> 
  rename(HIX = HIX.,
         BIX = BIX.) |>  #### can just change the rename here for what value you want to look at
  dplyr::select(Site, Site_Class, Depth_m, Date, Distance, Dry_start, Dry_end, HIX, BIX) |> 
  group_by(Site, Site_Class, Depth_m, Date, Dry_start, Dry_end, Distance) |> 
  summarise(HIX_mean = mean(HIX, na.rm = T),
            HIX_min = min(HIX, na.rm = T),
            HIX_max = max(HIX, na.rm = T),
            BIX_mean = mean(BIX, na.rm = T),
            BIX_min = min(BIX, na.rm = T),
            BIX_max = max(BIX, na.rm = T)
                        ) |> 
  mutate(Rep = ifelse(HIX_mean != HIX_min, "Y", "N"))

zzz <- arrange(eems_summary, Date, desc(Site), Depth_m)



#plot w/ error bars
eems_summary |> 
  ggplot(aes(x = Distance, y = HIX_mean, color = Depth_m)) +
  geom_point(size = 1) +  # Plot the mean values as points
  geom_errorbar(
    aes(ymin = HIX_min, ymax = HIX_max),
    width = 2  # Width of the error bars
  ) +
  facet_wrap(~Date, nrow = 4)+
  theme_bw()

#by site and date
eems_summary |> 
  filter(Rep == "Y") |> 
  ggplot(aes(y = Depth_m, x= HIX_mean))+
  geom_point(size = 1) +  
  geom_errorbar(
    aes(xmin = HIX_min, xmax = HIX_max),
    width = 2 )+
  # xlim(3,6)+
  facet_grid(Site~Date)
  


```

## DWH exploration

put sensors, eems, and hydrology all together
```{r}
head(eems_summary)
head(CCR_usgs_data)
head(sensors)

data <- sensors |> 
  select(Site, Date, Depth_m, Temp_C:SpCond_uScm) |> 
  full_join(eems_summary, by = c("Site", "Date", "Depth_m")) |> 
  left_join(CCR_usgs_data, by = "Date")

data <- eems_summary


```

make some plots 

```{r}

#all data by depth
data |> 
  ggplot(aes(x = Distance, y = HIX_mean, fill = Depth_m
             ))+
  geom_smooth()+
  geom_point(shape = 21, size = 3) + 
  geom_errorbar(aes(ymin = HIX_min, ymax = HIX_max), width = 2) +
  ylim(1.45,14.4)+
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18),
                    panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  labs(x= "Distance from Stream (m)",  fill = "Depth (m)", y = "HIX")+
  scale_x_continuous(breaks = c(0, 500, 1000, 1500))+  
  scale_fill_gradient2(low = "red",  high ="blue",
                       midpoint = 6,  guide = "colourbar", breaks = c(3,6,9, 15, 20))

#all depths by date
data |> 
  mutate(Julian = yday(Date)) |> 
  ggplot(aes(x = Distance, y = HIX_mean, color = (Julian)
             ))+
  geom_smooth()+
  geom_point(size = 3) + 
  ylim(1.45,14.4)+
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18),
                    panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  labs(x= "Distance from Stream (m)",  shape = "Site Type")+
  scale_x_continuous(breaks = c(0, 500, 1000, 1500))+
  scale_color_viridis_b(breaks = c(100,200,300))


#just 0.1 m 
data |> 
  filter(Depth_m == 0.1) |> 
  ggplot(aes(x = Distance, y = HIX_mean, color = as.factor(Date)
             ))+
  geom_point() + 
  geom_line()+
  ylim(1.45,14.4)+
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18),
                    panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  labs(x= "Distance from Stream (m)",  shape = "Site Type")+
  scale_x_continuous(breaks = c(0, 500, 1000, 1500))


#averaged across depths BY DATE
data |> 
  group_by(Date, Site, Distance) |> 
  summarise(HIX_mean_depth = mean(HIX_mean, na.rm = T),
            HIX_min = min(HIX_mean, na.rm = T),
            HIX_max = max(HIX_mean, na.rm = T)) |> 
  ggplot(aes(x = Distance, y = HIX_mean_depth, color = as.factor(Date)
             ))+
  geom_point() + 
  geom_errorbar(aes(ymin = HIX_min, ymax = HIX_max), width = 2) +
  ylim(1.45,14.4)+
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18),
                    panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  labs(x= "Distance from Stream (m)",  shape = "Site Type")+
  scale_x_continuous(breaks = c(0, 500, 1000, 1500))


# #averaged across depths BY Cond
# data |> 
#   group_by(Date, Site, Distance, SpCond_uScm) |> 
#   summarise(HIX_mean_depth = mean(HIX_mean, na.rm = T),
#             HIX_min = min(HIX_mean, na.rm = T),
#             HIX_max = max(HIX_mean, na.rm = T)) |> 
#   ggplot(aes(x = Distance, y = HIX_mean_depth, color = SpCond_uScm
#              ))+
#   geom_point() + 
#   geom_smooth()+
#   geom_errorbar(aes(ymin = HIX_min, ymax = HIX_max), width = 2) +
#   ylim(1.45,14.4)+
#   theme_bw()+ theme(legend.position = "top", text = element_text(size = 18),
#                     panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
#   labs(x= "Distance from Stream (m)",  shape = "Site Type")+
#   scale_x_continuous(breaks = c(0, 500, 1000, 1500))+
#     scale_color_gradient(low = "red",  high ="blue")


#averaged across depths BY STAGE
summary(data$CCR_HPB_daily_waterlevel_cm)

data |> 
  group_by(Date, Site, Distance, CCR_HPB_daily_waterlevel_cm) |> 
  summarise(HIX_mean_depth = mean(HIX_mean, na.rm = T),
            HIX_min = min(HIX_mean, na.rm = T),
            HIX_max = max(HIX_mean, na.rm = T)) |> 
  ggplot(aes(x = Distance, y = HIX_mean_depth, fill = CCR_HPB_daily_waterlevel_cm
             ))+
  geom_smooth()+
  geom_point(shape = 21, size = 3) + 
  geom_errorbar(aes(ymin = HIX_min, ymax = HIX_max), width = 2) +
  ylim(1.45,14.4)+
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18),
                    panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  labs(x= "Distance from Stream (m)",  fill = "Stream Water Level (cm)", y = "HIX")+
  scale_x_continuous(breaks = c(0, 500, 1000, 1500))+
    scale_fill_gradient2(low = "red",  high ="blue", midpoint = 7)

#stage all data
data |> 
  ggplot(aes(x = Distance, y = HIX_mean, fill = CCR_HPB_daily_waterlevel_cm
             ))+
  geom_smooth()+
  geom_point(shape = 21, size = 3) + 
  geom_errorbar(aes(ymin = HIX_min, ymax = HIX_max), width = 2) +
  ylim(1.45,14.4)+
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18),
                    panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  labs(x= "Distance from Stream (m)",  fill = "Stream Water Level (cm)", y = "HIX")+
  scale_x_continuous(breaks = c(0, 500, 1000, 1500))+
    scale_fill_gradient2(low = "red",  high ="blue", midpoint = 7)




```

## EEMs change from site S1 

```{r}

eems_summary |> 
  select(1:7, HIX_mean) |> 
  pivot_wider(names_from = Site, values_from = HIX_mean)

s1 <- eems_summary |> 
  ungroup() |> 
  filter(Site == "101") |> 
  select(Site, Date, HIX_mean) |> 
  rename(HIX_S1 = HIX_mean)

#merged_df <- merge(eems_summary, s1[, c('Date', 'H')], by = c('Depth', 'Date'), suffixes = c("", "_SiteA"))

merged_df <- left_join(eems_summary, s1, by = "Date")

merged_df |> 
  mutate(diff_S1 = HIX_mean - HIX_S1) |> 
  ggplot(aes(x = Distance, y = diff_S1, fill = Depth_m,
             shape = factor(Site_Class, levels = c("Stream", "Pool", "Cove", "Pelagic"))
             ))+
  geom_rect(aes(xmin = Dry_start, xmax = Dry_end, ymin = -Inf, ymax = Inf), 
            alpha = 0.1, fill = "gray", color = NA )+ #color gets rid of border
  geom_point(size = 3) +  #shape = 21
  geom_hline(yintercept = 0)+
  facet_wrap(~Date, scales = "fixed", ncol = 7)+ 
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18),
                    panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
    labs(x= "Distance from Stream (m)",
       shape = "Site Type")+
  scale_x_continuous(breaks = c(0, 500, 1000, 1500))+ 
  scale_shape_manual(values = c(24, 22, 21, 25))+ 
  scale_fill_gradient2(low = "red",  high ="blue",
                       midpoint = 6,  guide = "colourbar", breaks = c(3,6,9, 15, 20))


merged_df |> 
  mutate(diff_S1 = HIX_mean - HIX_S1) |> 
  ggplot(aes(x = Distance, y = diff_S1, fill = Depth_m,
             shape = factor(Site_Class, levels = c("Stream", "Pool", "Cove", "Pelagic"))
             ))+
  geom_point(size = 3) +  #shape = 21
  geom_hline(yintercept = 0)+
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18),
                    panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
    labs(x= "Distance from Stream (m)",
       shape = "Site Type")+
  scale_x_continuous(breaks = c(0, 500, 1000, 1500))+ 
  scale_shape_manual(values = c(24, 22, 21, 25))+ 
  scale_fill_gradient2(low = "red",  high ="blue",
                       midpoint = 6,  guide = "colourbar", breaks = c(3,6,9, 15, 20))
  


```



## EEMs plots by distance, value on Y

Trying depth on Y 

```{r}

# maxdepth_df <- eems_summary |> 
#   group_by(Site, Date) |> 
#   summarise(max_depth = max(Depth_m) + 0.2)

summary(eems_summary$HIX_mean)

## trial 1 
eems_summary |> 
  group_by(Site, Date) |> 
  mutate(max_depth = max(Depth_m) + 0.5) |> 
  ggplot(aes(x = Distance, y = Depth_m , fill = HIX_mean))+
    geom_rect(aes(xmin = Dry_start, xmax = Dry_end, ymin = -Inf, ymax = Inf), 
            alpha = 0.1, fill = "gray", color = NA )+ #color gets rid of border
  geom_point(shape = 21, color = "black", size = 3) + 
   geom_line(aes(y = max_depth), color = "black")+
   geom_hline(yintercept = -0.5)+
  scale_y_reverse()+
  # geom_errorbar(aes(ymin = HIX_min, ymax = HIX_max), width = 2) +
  facet_wrap(~Date, scales = "fixed", ncol = 7)+ 
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18),
                    panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
    labs(x= "Distance from Stream (m)",
       shape = "Site Type")+
  scale_x_continuous(breaks = c(0, 500, 1000, 1500))+
    scale_fill_gradient(low = "green",  high ="brown",# midpoint = 5,
                         guide = "colourbar", breaks = c(1,3,5,7,9,11,13))
  # scale_color_gradient2(low = "red",  high ="blue",
  #                      midpoint = 5,  guide = "colourbar", breaks = c(0,2,4,6,8,10,12))




##T2
eems_summary |> 
  #filter(Site > 50) |> 
  group_by(Site, Date) |> 
  mutate(max_depth = max(Depth_m) + 0.5) |> 
  ggplot(aes(x = Distance, y = Depth_m, fill = HIX_mean))+
  geom_point(shape = 21, color = "black", size = 3) + 
  geom_line(aes(y = max_depth), color = "black")+
  geom_hline(yintercept = -0.5)+
  # scale_y_log10()+
  scale_y_continuous(trans = ggforce::trans_reverser('log10')) +
  #scale_y_reverse()+
  # geom_errorbar(aes(ymin = HIX_min, ymax = HIX_max), width = 2) +
  facet_wrap(~Date, scales = "fixed", ncol = 4)+ 
  geom_rect(aes(xmin = Dry_start, xmax = Dry_end, ymin = -Inf, ymax = Inf), 
            alpha = 0.01, fill = "gray", color = NA )+ #color gets rid of border
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18),
                    panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
    labs(x= "Distance from Stream (m)",
       shape = "Site Type")+
  scale_x_continuous(breaks = c(0, 500, 1000, 1500))+
    scale_fill_gradient(low = "green",  high ="brown",# midpoint = 5,
                         guide = "colourbar", breaks = c(1,3,5,7,9,11,13))





```

Value on Y

```{r}

eems_summary |> 
  ggplot(aes(x = Distance, y = HIX_mean, fill = Depth_m,
             #shape = factor(Site_Class, levels = c("Stream", "Pool", "Cove", "Pelagic"))
             ))+
    geom_rect(aes(xmin = Dry_start, xmax = Dry_end, ymin = -Inf, ymax = Inf), 
            alpha = 0.1, fill = "gray", color = NA )+ #color gets rid of border
  geom_point(shape = 21, size = 3) + 
  geom_errorbar(aes(ymin = HIX_min, ymax = HIX_max), width = 2) +
  facet_wrap(~Date, scales = "fixed", ncol = 7)+ 
  ylim(1.45,14.4)+
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18),
                    panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
    labs(x= "Distance from Stream (m)",
       shape = "Site Type")+
  scale_x_continuous(breaks = c(0, 500, 1000, 1500))+ 
  #scale_shape_manual(values = c(24, 22, 21, 25))+ 
  scale_fill_gradient2(low = "red",  high ="blue",
                       midpoint = 6,  guide = "colourbar", breaks = c(3,6,9, 15, 20))



```




Depth by gradient  

```{r}
#HIX averaging reps 
eems_summary |> 
  ggplot(aes(x = Distance, y = HIX_mean, color = Depth_m, fill = Depth_m,
             shape = factor(Site_Class, levels = c("Stream", "Pool", "Cove", "Pelagic"))))+
  geom_point() + 
  geom_errorbar(aes(ymin = HIX_min, ymax = HIX_max), width = 2) +
  facet_wrap(~Date, scales = "fixed", ncol = 4)+ 
  geom_rect(aes(xmin = Dry_start, xmax = Dry_end, ymin = -Inf, ymax = Inf), 
            alpha = 0.01, fill = "gray", color = NA )+ #color gets rid of border
  ylim(1.45,14.4)+
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18))+
    labs(x= "Distance from Stream (m)",
       shape = "Site Type")+
  scale_shape_manual(values = c(24, 22, 21, 25))+ #18, 15, 16, 17
  scale_color_gradient(high = "#CFCFCF", low = "black", breaks = c(3,6,9,12))+
  scale_fill_gradient(high = "#CFCFCF", low = "black",  breaks = c(3,6,9,12)) # high = "black", low = "#CFCFCF"  ;  high = "red", low = "blue"


#BIX averaging reps 
eems_summary |> 
  ggplot(aes(x = Distance, y = BIX_mean, color = Depth_m, fill = Depth_m,
             shape = factor(Site_Class, levels = c("Stream", "Pool", "Cove", "Pelagic"))))+
  geom_point() + 
  geom_errorbar(aes(ymin = BIX_min, ymax = BIX_max), width = 2) +
  facet_wrap(~Date, scales = "fixed", ncol = 4)+ 
  geom_rect(aes(xmin = Dry_start, xmax = Dry_end, ymin = -Inf, ymax = Inf), 
            alpha = 0.01, fill = "gray", color = NA )+ #color gets rid of border
  ylim(0.51, 0.89)+
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18))+
    labs(x= "Distance from Stream (m)",
       shape = "Site Type")+
  scale_shape_manual(values = c(24, 22, 21, 25))+ #18, 15, 16, 17
  scale_color_gradient(high = "#CFCFCF", low = "black", breaks = c(3,6,9,12))+
  scale_fill_gradient(high = "#CFCFCF", low = "black",  breaks = c(3,6,9,12)) # high = "black", low = "#CFCFCF"  ;  high = "red", low = "blue"



##adpating sensors new color 

eems_summary |> 
  ggplot(aes(x = Distance, y = HIX_mean, color = Depth_m, fill = Depth_m,
             shape = factor(Site_Class, levels = c("Stream", "Pool", "Cove", "Pelagic"))))+
  geom_point() + 
  geom_errorbar(aes(ymin = HIX_min, ymax = HIX_max), width = 2) +
  facet_wrap(~Date, scales = "fixed", ncol = 4)+ 
  geom_rect(aes(xmin = Dry_start, xmax = Dry_end, ymin = -Inf, ymax = Inf), 
            alpha = 0.01, fill = "gray", color = NA )+ #color gets rid of border
  ylim(1.45,14.4)+
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18),
                    panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
    labs(x= "Distance from Stream (m)",
       shape = "Site Type")+
  scale_shape_manual(values = c(24, 22, 21, 25))+ #18, 15, 16, 17
    scale_color_gradient2(low = "#333333", mid = "#7A7A7A", high ="#E5E5E5",
                       midpoint = 2,  guide = "colourbar", breaks = c(3,6,9, 15, 20))+
  scale_fill_gradient2(low = "#333333", mid = "#7A7A7A", high ="#E5E5E5",
                       midpoint = 2,  guide = "colourbar", breaks = c(3,6,9, 15, 20))


## Red to blue color pallet
eems_summary |> 
  ggplot(aes(x = Distance, y = HIX_mean, fill = Depth_m,
             shape = factor(Site_Class, levels = c("Stream", "Pool", "Cove", "Pelagic"))))+
  geom_point() + 
  geom_errorbar(aes(ymin = HIX_min, ymax = HIX_max), width = 2) +
  facet_wrap(~Date, scales = "fixed", ncol = 4)+ 
  geom_rect(aes(xmin = Dry_start, xmax = Dry_end, ymin = -Inf, ymax = Inf), 
            alpha = 0.01, fill = "gray", color = NA )+ #color gets rid of border
  ylim(1.45,14.4)+
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18),
                    panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
    labs(x= "Distance from Stream (m)",
       shape = "Site Type")+
  scale_x_continuous(breaks = c(0, 500, 1000, 1500))+ #c(250, 750)
  scale_shape_manual(values = c(24, 22, 21, 25))+ #18, 15, 16, 17
  scale_fill_gradient2(low = "red",  high ="blue",
                       midpoint = 9,  guide = "colourbar", breaks = c(3,6,9, 15, 20))


eems_summary |> 
  ggplot(aes(x = Distance, y = BIX_mean, fill = Depth_m,
             shape = factor(Site_Class, levels = c("Stream", "Pool", "Cove", "Pelagic"))))+
  geom_point() + 
  geom_errorbar(aes(ymin = BIX_min, ymax = BIX_max), width = 2) +
  facet_wrap(~Date, scales = "fixed", ncol = 4)+ 
  geom_rect(aes(xmin = Dry_start, xmax = Dry_end, ymin = -Inf, ymax = Inf), 
            alpha = 0.01, fill = "gray", color = NA )+ #color gets rid of border
  ylim(0.51, 0.89)+
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18),
                    panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
    labs(x= "Distance from Stream (m)",
       shape = "Site Type")+
  scale_x_continuous(breaks = c(0, 500, 1000, 1500))+ #c(250, 750)
  scale_shape_manual(values = c(24, 22, 21, 25))+ #18, 15, 16, 17
  scale_fill_gradient2(low = "red",  high ="blue",
                       midpoint = 9,  guide = "colourbar", breaks = c(3,6,9, 15, 20))


```

Depth by group

```{r}

#averaging reps  AND TRYING DEPTH SHAPE GROUPS
levels_depthgroup <- c("0.1m", "0.2 - 1m",  "1 - 2m", "3 - 7m", "9m", " >= 10m")

#HIX
eems_summary |> 
  mutate(depth_group = ifelse(Depth_m == 0.1, "0.1m", NA),
         depth_group = ifelse(Depth_m <= 1 & Depth_m > 0.1, "0.2 - 1m", depth_group),
         depth_group = ifelse(Depth_m <= 2 & Depth_m > 1, "1 - 2m", depth_group),
         depth_group = ifelse(Depth_m <= 7 & Depth_m >= 3, "3 - 7m", depth_group),
         depth_group = ifelse(Depth_m == 9 , "9m", depth_group),
         depth_group = ifelse(Depth_m >= 10 , " >= 10m", depth_group)
         ) |> 
  ggplot(aes(x = Distance, y = HIX_mean, color = factor(depth_group, levels = levels_depthgroup))) +
  geom_point() + 
  geom_errorbar(aes(ymin = HIX_min, ymax = HIX_max), width = 2) +
  facet_wrap(~Date, nrow = 4)+
  facet_wrap(~Date, scales = "fixed", ncol = 6)+ 
  geom_rect(aes(xmin = Dry_start, xmax = Dry_end, ymin = 2, ymax = 2.5), # for BIX use 0.5 and 0.51
             alpha = 0.1, fill = "blue" )+
  labs(color = "Depth", y = "HIX")+
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18))+ guides(colour = guide_legend(nrow = 1))

#BIX
eems_summary |> 
  mutate(depth_group = ifelse(Depth_m == 0.1, "0.1m", NA),
         depth_group = ifelse(Depth_m <= 1 & Depth_m > 0.1, "0.2 - 1m", depth_group),
         depth_group = ifelse(Depth_m <= 2 & Depth_m > 1, "1 - 2m", depth_group),
         depth_group = ifelse(Depth_m <= 7 & Depth_m >= 3, "3 - 7m", depth_group),
         depth_group = ifelse(Depth_m == 9 , "9m", depth_group),
         depth_group = ifelse(Depth_m >= 10 , " >= 10m", depth_group)
         ) |> 
  ggplot(aes(x = Distance, y = BIX_mean, color = factor(depth_group, levels = levels_depthgroup))) +
  geom_point() + 
  geom_errorbar(aes(ymin = BIX_min, ymax = BIX_max), width = 2) +
  facet_wrap(~Date, nrow = 4)+
  facet_wrap(~Date, scales = "fixed", ncol = 2)+ 
  geom_rect(aes(xmin = Dry_start, xmax = Dry_end, ymin = 0.5, ymax = 0.51), # for BIX use 0.5 and 0.51
             alpha = 0.1, fill = "blue" )+
  labs(color = "Depth", y = "BIX")+
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18))+ guides(colour = guide_legend(nrow = 1))


```



## by Codes 

```{r}
##previous style plot
levels_sites <- c(101, 100, 98, 96, 94, 92, 90, 88, 50)
levels_sites_code <- c("S1", "S2", "P1", "P2", "C1", "C2", "C3", "C4", "50")


# set up colors for factored depths 
depths <- c(0.1, 0.5, 1, 1.5, 2, 6)
colors <- scales::seq_gradient_pal(low = "blue", high = "#ff0000", space = "Lab")(1:6/6)
color_values <- setNames(colors, depths)

## HIX and BIX by date w/ depth as specific color 
eems_plotting |> 
  select(Reservoir, Site, Site_code, Depth_m, Date, Distance, FI., HIX., BIX.) |> 
  pivot_longer(-c(1:6)) |> 
  # ggplot(aes(x = factor(Site, level = levels_sites), y = value, color = factor(Depth_m)))+
  ggplot(aes(x = factor(Site_code, level = levels_sites_code), y = value, color = factor(Depth_m)))+
  geom_jitter(size = 2.5, width = 0.1)+
  facet_wrap(~name, nrow = 3, scales = "free_y")+
  # labs(title = "HPB", y = "Temp (C)", x = "Site")+
  theme_bw()+ theme(legend.position = "top", text = element_text(size = 18))+
  scale_color_manual(values = c("0.1" = "#66ADE5", "0.5" = "#BF1B0B", "1.5" = "#FFC465", "2" = "#009E73", "6" = "#252A52"))
  # scale_color_manual(values = color_values)
  # scale_color_gradient("Depth_m",  high = "red", low = "blue") 
  
### HIX and BIX by date with Depth as specific color as gradient 
eems_plotting |>
  select(1:6, HIX., BIX.) |> 
  pivot_longer(-c(1:6)) |>
  # ggplot(aes(x = Distance, y = value, color = Depth_m))+
  ggplot(aes(x = factor(Site_code, levels = levels_sites_code), y = value, color = Depth_m))+
  geom_point()+
  #facet_wrap(~Date, nrow = 3, scales = "free_y")+
  facet_grid(name~Date, scales = "free_y")+
  labs(x = element_blank())+
  theme_bw()+ theme(legend.position = "right", text = element_text(size = 14))+
  scale_color_gradient("Depth_m",  high = "red", low = "blue")

## hIX by date with depth on Y
eems_plotting |>
  select(1:6, HIX.) |> 
  pivot_longer(-c(1:6)) |>
  ggplot(aes(x = factor(Site_code, levels = levels_sites_code), y = Depth_m, color = value))+
  geom_point()+
  scale_y_reverse()+
  facet_grid(name~Date, scales = "free_y")+ 
  theme_bw()+ theme(legend.position = "right", text = element_text(size = 14))+
  # viridis::scale_color_viridis()
  scale_color_gradient(high = "black", low = "#CFCFCF") # has also done red to blue w/ some luck
  # scale_color_gradientn(colors = magma(256))

## BIX by date with depth on Y
eems_plotting |>
  select(1:6, BIX.) |> 
  pivot_longer(-c(1:6)) |>
  ggplot(aes(x = factor(Site_code, levels = levels_sites_code), y = Depth_m, color = value))+
  geom_point()+
  scale_y_reverse()+
  facet_grid(name~Date, scales = "free_y")+ 
  theme_bw()+ theme(legend.position = "right", text = element_text(size = 14))+
  scale_color_gradient(high = "black", low = "#CFCFCF") # has also done red to blue w/ some luck


##### NEW STYLE TRials 
eems_plotting |>
  select(1:6, BIX.) |> 
  pivot_longer(-c(1:6)) |>
  ggplot(aes(x = value, y = Depth_m, color = as.factor(Distance)))+
  geom_point()+
  geom_line(orientation = "y")+
  scale_y_reverse()+
  facet_wrap(~Date, scales = "free_y")+ 
  theme_bw()+ theme(legend.position = "right", text = element_text(size = 14))
  # scale_color_gradient(high = "black", low = "#CFCFCF") # has also done red to blue w/ some luck
  

```



## MSN eems

```{r}
eems_MSN <- eems24 |> 
  mutate(Date = mdy(Date)) |> 
  filter(Date %in% c(ymd("2024-07-31"), ymd("2024-08-01")))

head(eems_MSN)

eems_MSN |> 
  ggplot(aes(x = factor(TIME, levels = c("noon", "midnight", "6am")), y = HIX., color = Depth_m))+
  geom_point()


eems_MSN |> 
  ggplot(aes(x = factor(TIME, levels = c("noon", "midnight", "6am")), y = BIX., color = Depth_m))+
  geom_point()

```




